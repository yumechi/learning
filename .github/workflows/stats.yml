name: Notify chapter count

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    # SLACK_WEBHOOK_URL がセットされていない場合は実行しない
    if: ${{ env.SLACK_WEBHOOK_URL != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: 'Setup Deno'
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      # 前回のデータをキャッシュから復元
      - name: Restore cache
        uses: actions/cache@v3
        id: cache
        with:
          path: stats_cache.json
          key: daily_stats

      - name: Initialize stats_cache.json if not restored
        run: |
          if [ ! -f stats_cache.json ]; then
            echo '{"chapterCount": 0}' > stats_cache.json
          fi

      - name: Compare and Notify with Deno
        with:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
        run: |
          deno run --allow-read --allow-write --allow-env --allow-net .github/scripts/stats.ts \
            stats_cache.json src/catalog.yml
